name: ðŸš€ Pipeline de IntegraciÃ³n Continua

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # ============================================
  # ðŸ CI BACKEND
  # ============================================
  
  backend-lint:
    name: ðŸ Lint y Formato Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./back-end
    
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: './back-end/requirements.txt'

      - name: ðŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff black isort mypy

      - name: ðŸ” Ruff - Linter RÃ¡pido
        run: |
          ruff check app/ --output-format=github || true

      - name: ðŸŽ¨ Black - Verificar Formato
        run: |
          black --check --diff app/ || true

      - name: ðŸ“‹ isort - Verificar Orden de Imports
        run: |
          isort --check-only --diff app/ || true

      - name: ðŸ”Ž MyPy - VerificaciÃ³n de Tipos
        run: |
          mypy app/ --ignore-missing-imports || true
        continue-on-error: true

  backend-test:
    name: ðŸ§ª Pruebas Backend
    runs-on: ubuntu-latest
    needs: backend-lint
    defaults:
      run:
        working-directory: ./back-end
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: test_db
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpassword
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: './back-end/requirements.txt'

      - name: ðŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: ðŸ§ª Ejecutar Pruebas
        env:
          DATABASE_URL: mysql+pymysql://testuser:testpassword@localhost:3306/test_db
          SECRET_KEY: clave-secreta-solo-para-pruebas-ci
        run: |
          pytest app/tests/ -v --cov=app --cov-report=xml --cov-report=term-missing || true

      - name: ðŸ“Š Subir Cobertura
        uses: codecov/codecov-action@v5
        with:
          files: ./back-end/coverage.xml
          flags: backend
          name: cobertura-backend
        continue-on-error: true

  # ============================================
  # ðŸ…°ï¸ CI FRONTEND
  # ============================================
  
  frontend-lint:
    name: ðŸ…°ï¸ Lint y Formato Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./front-end/portafolio
    
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“— Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './front-end/portafolio/package-lock.json'

      - name: ðŸ“¦ Instalar dependencias
        run: npm ci

      - name: ðŸ” ESLint - AnÃ¡lisis de CÃ³digo
        run: |
          npx ng lint || true
        continue-on-error: true

      - name: ðŸŽ¨ Prettier - Verificar Formato
        run: |
          npx prettier --check "src/**/*.{ts,html,scss}" || true
        continue-on-error: true

  frontend-build:
    name: ðŸ—ï¸ Compilar Frontend
    runs-on: ubuntu-latest
    needs: frontend-lint
    defaults:
      run:
        working-directory: ./front-end/portafolio
    
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“— Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './front-end/portafolio/package-lock.json'

      - name: ðŸ“¦ Instalar dependencias
        run: npm ci

      - name: ðŸ—ï¸ Compilar para ProducciÃ³n
        run: npm run build -- --configuration production

      - name: ðŸ“¦ Subir Artefacto de CompilaciÃ³n
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: front-end/portafolio/dist/
          retention-days: 7

  frontend-test:
    name: ðŸ§ª Pruebas Frontend
    runs-on: ubuntu-latest
    needs: frontend-lint
    defaults:
      run:
        working-directory: ./front-end/portafolio
    
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“— Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './front-end/portafolio/package-lock.json'

      - name: ðŸ“¦ Instalar dependencias
        run: npm ci

      - name: ðŸ§ª Ejecutar Pruebas Unitarias
        run: |
          npm test -- --no-watch --no-progress --browsers=ChromeHeadless --code-coverage || true
        continue-on-error: true

  # ============================================
  # ðŸ³ COMPILACIÃ“N DOCKER
  # ============================================
  
  docker-build:
    name: ðŸ³ Prueba de CompilaciÃ³n Docker
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-build]
    
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ³ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Compilar Imagen Backend
        uses: docker/build-push-action@v5
        with:
          context: ./back-end
          push: false
          tags: portfolio-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ—ï¸ Compilar Imagen Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./front-end
          push: false
          tags: portfolio-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # ðŸ“‹ RESUMEN CI
  # ============================================
  
  ci-summary:
    name: ðŸ“‹ Resumen CI
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-test, frontend-lint, frontend-build, frontend-test, docker-build]
    if: always()
    
    steps:
      - name: ðŸ“Š Generar Resumen
        run: |
          echo "## ðŸš€ Resumen del Pipeline de CI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Trabajo | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Lint Backend | ${{ needs.backend-lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Pruebas Backend | ${{ needs.backend-test.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ…°ï¸ Lint Frontend | ${{ needs.frontend-lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ CompilaciÃ³n Frontend | ${{ needs.frontend-build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Pruebas Frontend | ${{ needs.frontend-test.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ CompilaciÃ³n Docker | ${{ needs.docker-build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
