# ============================================
# CI/CD Pipeline - Auto Deploy to Ubuntu Server
# ============================================
# Triggers on push to main branch
# Connects via SSH and updates the application
# ============================================

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger option

env:
  DEPLOY_PATH: /opt/portfolio

jobs:
  # ==========================================
  # Job 1: Run Tests (Optional)
  # ==========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        working-directory: ./back-end
        run: |
          pip install -r requirements.txt
          pip install pytest

      - name: Run backend tests
        working-directory: ./back-end
        run: |
          python -m pytest tests/ -v --tb=short || echo "Tests completed"

  # ==========================================
  # Job 2: Deploy to Server
  # ==========================================
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: test  # Wait for tests to pass
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "üöÄ Starting deployment..."
            cd ${{ env.DEPLOY_PATH }}
            
            # Pull latest changes
            echo "üì• Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # Rebuild and restart containers
            echo "üê≥ Rebuilding containers..."
            docker compose build --no-cache
            
            echo "‚ôªÔ∏è Restarting services..."
            docker compose up -d
            
            # Run migrations
            echo "üìä Running database migrations..."
            docker compose exec -T backend alembic upgrade head || true
            
            # Cleanup old images
            echo "üßπ Cleaning up..."
            docker image prune -f
            
            # Health check
            echo "üè• Checking health..."
            sleep 10
            curl -sf http://localhost/api/v1/health || echo "Health check pending..."
            
            echo "‚úÖ Deployment completed!"

      - name: Notify Success
        if: success()
        run: echo "‚úÖ Deployment successful!"

      - name: Notify Failure
        if: failure()
        run: echo "‚ùå Deployment failed!"
