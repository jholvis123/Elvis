<div class="writeup-form-page">
    <form [formGroup]="writeupForm" (ngSubmit)="onSubmit()">

        <!-- Header -->
        <div class="form-header">
            <div class="header-content">
                <h1 class="text-3xl font-bold text-white mb-2">
                    {{ isEditMode ? '‚úèÔ∏è Editar Writeup' : 'üìù Nuevo Writeup' }}
                </h1>
                <p class="text-gray-400">{{ isEditMode ? 'Actualiza el writeup' : 'Documenta la soluci√≥n del CTF con el editor profesional' }}</p>
            </div>
            <div class="header-actions">
                <a [routerLink]="isEditMode ? ['/writeups', writeupId] : ['/writeups']"
                    class="btn-secondary">
                    Cancelar
                </a>
                <button type="submit" [disabled]="loading" class="btn-primary">
                    {{ loading ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Publicar') }}
                </button>
            </div>
        </div>

        <!-- Error -->
        <div class="error-banner" *ngIf="error">
            <span class="error-icon">‚ö†Ô∏è</span>
            <p>{{ error }}</p>
        </div>

        <div class="form-layout">
            <!-- Left Column - Metadata -->
            <aside class="form-sidebar">
                <!-- Title -->
                <div class="form-field">
                    <label class="field-label">T√≠tulo *</label>
                    <input type="text" formControlName="title"
                        class="field-input"
                        placeholder="T√≠tulo del writeup" />
                    <span class="field-error" *ngIf="writeupForm.get('title')?.touched && writeupForm.get('title')?.invalid">
                        El t√≠tulo es requerido (m√≠n. 5 caracteres)
                    </span>
                </div>

                <!-- CTF Selection -->
                <div class="form-field">
                    <label class="field-label">üéØ Reto CTF (Opcional)</label>
                    <select formControlName="ctf_id" class="field-input">
                        <option value="">Sin CTF asociado</option>
                        <option *ngFor="let ctf of ctfs" [value]="ctf.id">
                            {{ ctf.title }} ({{ ctf.category }})
                        </option>
                    </select>
                </div>

                <!-- Summary -->
                <div class="form-field">
                    <label class="field-label">üìã Resumen</label>
                    <textarea formControlName="summary" rows="3" maxlength="500"
                        class="field-input"
                        placeholder="Breve descripci√≥n del writeup..."></textarea>
                    <span class="field-hint">{{ writeupForm.get('summary')?.value?.length || 0 }}/500 caracteres</span>
                </div>

                <!-- Tools -->
                <div class="form-field">
                    <div class="field-header">
                        <label class="field-label">üõ†Ô∏è Herramientas</label>
                        <button type="button" (click)="addTool()" class="btn-add">+ Agregar</button>
                    </div>
                    <div formArrayName="tools_used" class="tags-list">
                        <div class="tag-item" *ngFor="let tool of tools.controls; let i = index">
                            <input [formControlName]="i" type="text"
                                class="tag-input" placeholder="ej: nmap" />
                            <button type="button" (click)="removeTool(i)" class="tag-remove">‚úï</button>
                        </div>
                        <p class="empty-hint" *ngIf="tools.length === 0">A√±ade las herramientas utilizadas</p>
                    </div>
                </div>

                <!-- Techniques -->
                <div class="form-field">
                    <div class="field-header">
                        <label class="field-label">üí° T√©cnicas</label>
                        <button type="button" (click)="addTechnique()" class="btn-add">+ Agregar</button>
                    </div>
                    <div formArrayName="techniques" class="tags-list">
                        <div class="tag-item" *ngFor="let technique of techniques.controls; let i = index">
                            <input [formControlName]="i" type="text"
                                class="tag-input" placeholder="ej: SQL Injection" />
                            <button type="button" (click)="removeTechnique(i)" class="tag-remove">‚úï</button>
                        </div>
                        <p class="empty-hint" *ngIf="techniques.length === 0">A√±ade las t√©cnicas aplicadas</p>
                    </div>
                </div>
            </aside>

            <!-- Right Column - Editor -->
            <main class="form-main">
                <div class="editor-container">
                    <app-markdown-editor
                        [value]="writeupForm.get('content')?.value || ''"
                        (valueChange)="onContentChange($event)"
                        (save)="onEditorSave($event)"
                        placeholder="Escribe tu writeup en Markdown..."
                    ></app-markdown-editor>
                    
                    <span class="field-error mt-2" *ngIf="writeupForm.get('content')?.touched && writeupForm.get('content')?.invalid">
                        El contenido es requerido (m√≠n. 100 caracteres)
                    </span>
                </div>
            </main>
        </div>
    </form>
</div>
